/* launch.ly Shopping Cart - v0.4.0 - 2014-09-04
 * https://github.com/launchly/launchly-cart
 * Copyright (c) 2014 Craig Sullivan; Licensed MIT */

var cart={billingCountry:"",billingState:"",can_pay_later:!1,cached:{},account_organisation:"",user_email:"",stripe_icon:"https://d1adef9hr2r55o.cloudfront.net/images/launchly-stripe-icon.png",secure_url:"",templates_path:"https://d1adef9hr2r55o.cloudfront.net/releases/0.4.0/launchly-cart.templates.html",css_path:"https://d1adef9hr2r55o.cloudfront.net/releases/0.4.0/cart.min.css",templates:["cart_checkout","cart_contact_details","cart_payment","cart_payment_failure","cart_payment_success","shopping_cart","state_select","cart_components"],"do":function(a){cart[a.data("cart-function")](a)},dec:function(a){jQuery.post("/__/cart/inc.json",cart.variant_data(a),function(a){jQuery(cart).trigger("cart.changed",[a]),jQuery(cart).trigger("cart.dec",[a])})},empty:function(){jQuery.get("/__/cart/empty.json",{authenticity_token:rails_authenticity_token},function(a){jQuery(cart).trigger("cart.changed",[a]),jQuery(cart).trigger("cart.empty",[a])})},get:function(a,b){jQuery.get("/__/cart.json",{authenticity_token:rails_authenticity_token},function(a){jQuery(cart).trigger("cart.changed",[a]),jQuery(cart).trigger("cart.get",[a]),b&&b()})},inc:function(a){jQuery.post("/__/cart/inc.json",cart.variant_data(a),function(a){jQuery(cart).trigger("cart.changed",[a]),jQuery(cart).trigger("cart.inc",[a])})},set:function(a){jQuery.post("/__/cart/set.json",cart.variant_data(a),function(a){jQuery(cart).trigger("cart.changed",[a]),jQuery(cart).trigger("cart.set",[a])})},item_id:function(a){return a.data("item")},variant_id:function(a){var b=jQuery("#v_"+a+" :selected").val();return"undefined"==typeof b&&(b=jQuery("#v_"+a).val()),b},qty:function(a){return jQuery("#q_"+a).val()},note:function(a){return jQuery("#notes_"+a).val()},variant_data:function(a){var b=cart.item_id(a),c=cart.variant_id(b),d=cart.qty(b),e=cart.note(b),f={authenticity_token:rails_authenticity_token,v:[]};return f.v.push(c),f["q_"+c]=d,e&&(f["notes_"+c]=e),f},pay:function(){var a=jQuery('a[data-cart-function="pay"]'),b=a.data("loading-text"),c=jQuery.ajax({type:"POST",url:cart.secure_url+"/__/pay/cart.json",beforeSend:function(){a.text(b)},data:{_launch_ly_session:jQuery("#session_id").val(),reference:jQuery("#cart_reference").val(),first_name:jQuery("#card_first_name").val(),last_name:jQuery("#card_last_name").val(),card_number:jQuery("#card_number").val(),payment_type:jQuery("#payment_type").val(),expires_month:jQuery("#card_expires_month").val(),expires_year:jQuery("#card_expires_year").val(),card_verification:jQuery("#card_verification").val()}});this.setup_callbacks(c,"payment")},stripe_pay:function(a){a._launch_ly_session=jQuery("#session_id").val(),a.reference=jQuery("#cart_reference").val();var b=jQuery.ajax({type:"POST",url:cart.secure_url+"/__/pay/cart.json",beforeSend:function(){jQuery("#cart-payment-processing-placeholder").modal({backdrop:!1})},data:a});this.setup_callbacks(b,"payment")},paypal:function(){var a=jQuery.ajax({type:"POST",url:cart.secure_url+"/__/pay/paypal.json",data:{_launch_ly_session:jQuery("#session_id").val(),reference:jQuery("#cart_reference").val(),return_url:document.URL}});a.done(function(a){window.location=a.paypal_url}),a.fail(function(a){switch(a.status){case 400:jQuery(cart).trigger("cart.paypal.failure",a.responseJSON);break;case 500:window.alert("Sorry, there was a server error. Our administrators have been alerted.")}})},paypal_confirm_purchase:function(){var a=jQuery.ajax({type:"POST",url:cart.secure_url+"/__/pay/paypal/confirm.json",data:{_launch_ly_session:jQuery("#session_id").val(),reference:jQuery("#cart_reference").val()}});this.setup_callbacks(a,"paypal.confirm")},paypal_cancel_purchase:function(){var a=jQuery.ajax({type:"POST",url:cart.secure_url+"/__/pay/paypal/cancel.json",data:{_launch_ly_session:jQuery("#session_id").val(),reference:jQuery("#cart_reference").val()}});this.setup_callbacks(a,"paypal.cancel")},on_account:function(){var a=jQuery.ajax({type:"POST",url:cart.secure_url+"/__/pay/on_account.json",data:{_launch_ly_session:jQuery("#session_id").val(),reference:jQuery("#cart_reference").val()}});this.setup_callbacks(a,"on_account")},price:function(a){var b=cart.item_id(a),c=cart.qty(b);""===c||isNaN(parseInt(c,10))||jQuery.getJSON("/__/price_check/"+cart.variant_id(b)+"/"+c+".json",{authenticity_token:rails_authenticity_token},function(a){jQuery(cart).trigger("cart.price",[a])})},setup_callbacks:function(a,b){a.done(function(a){jQuery(cart).trigger("cart."+b+".success",a)}),a.fail(function(a){switch(a.status){case 400:jQuery(cart).trigger("cart."+b+".failure",a.responseJSON);break;case 500:window.alert("Sorry, there was a server error. Our administrators have been alerted.")}})},payment_type_from_number:function(a){var b="";return a=a.replace(/[^\d]/g,""),a.match(/^37\d{13}/)&&(b="american_express"),(a.match(/^4\d{15}/)||a.match(/^4\d{12}/))&&(b="visa"),a.match(/^5[1-5]\d{14}jQuery/)&&(b="master"),a.match(/^36\d{11}/)&&(b="diners_club"),b},remove:function(a){jQuery.get("/__/cart/remove/"+a.data("variant")+".json",function(a){jQuery(cart).trigger("cart.changed",[a])})},update:function(){var a={authenticity_token:rails_authenticity_token,v:[],billing_line1:jQuery("#billing_line1").val(),billing_line2:jQuery("#billing_line2").val(),billing_suburb:jQuery("#billing_suburb").val(),billing_state:jQuery("#billing_state").val(),billing_state_other:jQuery("#billing_state_other").val(),billing_country:jQuery("#billing_country").val(),billing_post_code:jQuery("#billing_post_code").val(),shipping_same_as_billing:1,shipping_line1:jQuery("#shipping_line1").val(),shipping_line2:jQuery("#shipping_line2").val(),shipping_suburb:jQuery("#shipping_suburb").val(),shipping_state:jQuery("#shipping_state").val(),shipping_state_other:jQuery("#shipping_state_other").val(),shipping_country:jQuery("#shipping_country").val(),shipping_post_code:jQuery("#shipping_post_code").val(),coupon_code:jQuery("#coupon_code").val(),instructions_to_seller:jQuery("#instructions_to_seller").val(),telephone_number:jQuery("#telephone_number").val(),first_name:jQuery("#first_name").val(),last_name:jQuery("#last_name").val()};this.billingCountry=a.billing_country,this.billingState=a.billing_state,jQuery('input[data-cart="qty"]').each(function(b,c){var d=jQuery(this).attr("data-item");a.v.push(d),a["q_"+d]=jQuery(c).val()}),jQuery.post("/__/cart.json",a,function(a){jQuery(cart).trigger("cart.changed",[a])})},track_order:function(a){if("undefined"!=typeof ga){var b=a.order;jQuery.each(b.line_items,function(a,c){ga("ec:addProduct",{name:c.item_name,id:c.sku,variant:c.name_a+": "+c.name_b,price:c.price,quantity:c.quantity,coupon:b.coupon_code})}),ga("ec:setAction","purchase",{id:a.reference,affiliation:a.domain,revenue:b.grand_tota,shipping:b.shipping_and_handling,tax:b.tax_total,currency:b.currency,coupon:b.coupon_code})}},init:function(a){"undefined"!=typeof a.can_pay_later&&(cart.can_pay_later=a.can_pay_later),"undefined"!=typeof a.account_organisation&&(cart.account_organisation=a.account_organisation),"undefined"!=typeof a.user_email&&(cart.user_email=a.user_email),"undefined"!=typeof a.stripe_icon&&(cart.stripe_icon=a.stripe_icon),"undefined"!=typeof a.secure_url&&(cart.secure_url=a.secure_url),"undefined"!=typeof a.templates_path&&(cart.templates_path=a.templates_path),"undefined"!=typeof a.css_path&&(cart.css_path=a.css_path),cart.loadCSS(),cart.loadTemplates()},loadTemplates:function(){jQuery.ajax({url:cart.templates_path}).done(function(a){jQuery("body").append(a);var b=cart.templates.length;cart.cached={};for(var c=0;b>c;c++){var d=cart.templates[c],e="#"+d+"-template",f=jQuery(e).html();cart.store(d,f)}cart.loadComponents(),jQuery(cart).trigger("cart.ready")})},loadComponents:function(){var a={},b=cart.cached_template("cart_components",a);jQuery("body").prepend(b)},loadCSS:function(){jQuery("head").append(jQuery('<link rel="stylesheet" type="text/css">').attr("href",cart.css_path))},store:function(a,b){cart.cached[a]=Handlebars.compile(b)},render:function(a,b,c){"undefined"==typeof b&&(b={});var d=cart.cached[a](b);jQuery(c).html(d)},populate_states:function(a,b,c){var d=jQuery("#state-"+b+"-select-placeholder");d.empty();var e=a.val(),f=null;if(""!==e){var g="/__/countries/"+e+"/entities.json";jQuery.get(g,function(a){f={states:a.regions,type:b},d.html(cart.cached_template("state_select",f)),c&&jQuery("#billing_state").val(c)})}},select_payment_type:function(a){jQuery("#payment_type").val(a),jQuery(".payment-icon[data-type='"+a+"']").fadeTo("fast",1),jQuery(".payment-icon:not([data-type='"+a+"'])").fadeTo("slow",.2)},cached_template:function(a,b){return cart.cached[a](b)},toggle:function(){jQuery("#shopping-cart").toggleClass("sc-menu-open")}};jQuery(cart).on("cart.changed",function(a,b){var c=(new Date).getFullYear();b.expiry_years=[];for(var d=0;10>=d;d++)b.expiry_years.push(c+d);b.can_pay_later=cart.can_pay_later,b.account_organisation=cart.account_organisation,b.user_email=cart.user_email,b.stripe_icon=cart.stripe_icon,jQuery("#cart-contact-details-container").html(cart.cached_template("cart_contact_details",b)),jQuery("#cart-payment-container").html(cart.cached_template("cart_payment",b)),jQuery("#shopping-cart").html(cart.cached_template("shopping_cart",b)),cart.populate_states(jQuery("#billing_country"),"billing",b.billing_state),jQuery(".cart-checkout").html(cart.cached_template("cart_checkout",b))}),jQuery(cart).on("cart.empty",function(){"undefined"!=typeof ga&&(ga("ec:setAction","empty"),ga("send","event","UX","click","empty cart"))}),jQuery(cart).on("cart.on_account.failure",function(a,b){jQuery(cart).trigger("cart.payment.failure",b)}),jQuery(cart).on("cart.on_account.success",function(a,b){jQuery(cart).trigger("cart.payment.success",b)}),jQuery(cart).on("cart.payment.failure",function(a,b){jQuery("#cart-payment").modal("hide"),jQuery("#cart-payment-processing-placeholder").modal("hide"),jQuery("#cart-payment-failure-container").html(cart.cached_template("cart_payment_failure",b)),jQuery("#cart-payment-failure-placeholder").modal({backdrop:!1})}),jQuery(cart).on("cart.payment.success",function(a,b){jQuery("#cart-payment").modal("hide"),jQuery("#cart-payment-processing-placeholder").modal("hide"),jQuery("#cart-payment-success-container").html(cart.cached_template("cart_payment_success",b)),jQuery("#cart-payment-success-placeholder").modal({backdrop:!1}),cart.get(),cart.track_order(b)}),jQuery(cart).on("cart.paypal.cancel.success",function(){window.alert("You have not been charged."),window.location="/"}),jQuery(cart).on("cart.paypal.confirm.failure",function(a,b){b.has_paypal=!0,jQuery(cart).trigger("cart.payment.failure",b)}),jQuery(cart).on("cart.paypal.confirm.success",function(a,b){jQuery("#paypal-express-confirmation").hide(),jQuery(cart).trigger("cart.payment.success",b)}),jQuery(cart).on("cart.price",function(a,b){var c=b.formatted_price,d=b.formatted_original_selling_price;jQuery("#item_"+b.item_id+"_price").html(c),b.has_original_selling_price===!0?jQuery("#item_"+b.item_id+"_was_price").html("Was <del>"+d+"</del>"):jQuery("#item_"+b.item_id+"_was_price").html("&nbsp;")}),jQuery(cart).on("cart.ready",function(){cart.get()}),jQuery(cart).on("cart.set",function(){jQuery("#shopping-cart").toggleClass("sc-menu-open")}),jQuery(document).on("click","*[data-cart-function]",function(a){a.preventDefault(),cart.do(jQuery(this))}),jQuery(document).on("click","*[data-cart-screen]",function(a){a.preventDefault();var b=jQuery(this).data("cart-screen");if("payment"===b){jQuery("#cart-payment-failure-placeholder").modal("hide");var c=jQuery('a[data-cart-function="pay"]').data("text");jQuery('a[data-cart-function="pay"]').text(c)}jQuery("#cart-"+b).modal({backdrop:!1})}),jQuery(document).on("change","select[data-cart-variant]",function(a){a.preventDefault(),cart.price(jQuery(this))}),jQuery(document).on("keyup","input[data-cart-quantity]",function(a){a.preventDefault(),cart.price(jQuery(this))}),jQuery("#shopping-cart").on("changed",function(){jQuery("#store-inner").css("height",jQuery(window).height()-140)}),jQuery(document).on("change","#billing_country",function(){cart.populate_states(jQuery(this),"billing")}),jQuery(document).on("focus","#card_verification",function(){jQuery("#cvv-icon").fadeTo("fast",1)}),jQuery(document).on("blur","#card_verification",function(){jQuery("#cvv-icon").fadeTo("fast",.2)}),jQuery(document).on("change","#card_number",function(){cart.select_payment_type(cart.payment_type_from_number(jQuery("#card_number").val()))}),jQuery(document).on("click",".payment-icon",function(){cart.select_payment_type(jQuery(this).data("type"))}),jQuery(document).on("click","#pay-by-stripe",function(a){var b=jQuery(this),c=b.text();b.text("Loading").attr("disabled","disabled");var d=StripeCheckout.configure({key:jQuery(this).data("key"),image:jQuery(this).data("image"),token:function(a,b){cart.stripe_pay(a,b)},opened:function(){},closed:function(){b.text(c).removeAttr("disabled")}});d.open({name:jQuery(this).data("name"),description:jQuery(this).data("description"),amount:jQuery(this).data("amount"),email:jQuery(this).data("email"),currency:jQuery(this).data("currency")}),a.preventDefault()}),"undefined"!=typeof ga&&ga("require","ec");